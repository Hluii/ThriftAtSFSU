{% extends "base.html" %}

{% block title %}Home - SFSU Thrift Market{% endblock %}

{% block head %}
<!-- noUiSlider CSS for price filter -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
{% endblock %}

{% block content %}
<section style="display: flex; justify-content: center;">
  <div class="containerGrid">

    <!-- Filters Sidebar -->
    <div class="containerFixed" id="filtersContainer">
      <div class="filters">
        <h2>Filters</h2>

        <p>Price Range</p>
        <div class="price-slider-container">
          <div id="price-slider"></div>
          <div class="price-slider-values">
            $<span id="slider-price-min">0</span> – $<span id="slider-price-max">2000</span>
          </div>
        </div>

        <div class="condition">
          <label>Condition</label>
          <div class="radio-buttons">
            <label class="conditionButton">
              <input type="radio" name="condition" value="very-worn"> Very Worn
            </label>
            <label class="conditionButton">
              <input type="radio" name="condition" value="used"> Used
            </label>
            <label class="conditionButton">
              <input type="radio" name="condition" value="fairly-used"> Fairly Used
            </label>
            <label class="conditionButton">
              <input type="radio" name="condition" value="good-condition"> Good Condition
            </label>
            <label class="conditionButton">
              <input type="radio" name="condition" value="great-condition"> Great Condition
            </label>
          </div>
        </div>

        <div class="seller-rating">
          <p>Seller Rating:</p>
          <div class="stars">
            {% for i in range(1,6) %}
            <span class="star" data-value="{{ i }}">&#10029;</span>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="posted-since">
        <label id="selectedDateDisplay" for="postedDate">Posted Since:</label>
        <div class="calendar-wrapper">
          <button type="button" class="calendar-button" onclick="document.getElementById('postedDate').showPicker()">
            📅 Pick a Date
          </button>
          <input type="date" id="postedDate" class="hidden-date"
            onchange="document.getElementById('selectedDateDisplay').textContent = 'Posted Since: ' + this.value;">
        </div>
      </div>

      <button class="apply-button">Apply</button>
    </div>

    <!-- Search Results -->
    <div class="container">
      <div class="search-info">
        <p>
          Showing <strong>{{ count }}</strong> result{{ 's' if count != 1 else '' }}
          {% if category or keyword %}
          for
          {% if category %}Category: <strong>{{ category }}</strong>{% endif %}
          {% if keyword %}Keyword: <strong>{{ keyword }}</strong>{% endif %}
          {% else %}
          (All Products)
          {% endif %}
        </p>
        {% if user_is_logged_in %}
          <a href="{{ url_for('newListing') }}" class="btn btn-outline">Add New Listing</a>
        {% endif %}
      </div>

      <div class="product-list">
        {% for item in items %}
        <div class="product-card">
          <a href="{{ url_for('listingIndie') }}">
            <h3 class="product-title">{{ item.title }} — ${{ item.price }}</h3>
            <p class="product-description">{{ item.description }}</p>
            {% if item.has_image %}
            <img src="{{ url_for('serve_image', product_id=item.product_id) }}" alt="Product image"
              class="product-image">
            {% else %}
            <p><em>No image available</em></p>
            {% endif %}
          </a>
        </div>
        {% else %}
        <p>No items found matching your search.</p>
        {% endfor %}
      </div>
    </div>

  </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }} {# Include scripts from base.html (e.g., flash message hider) #}

<!-- Filter toggle (submenu provides the button when show_filters=True) -->
<script>
  const toggleBtn = document.getElementById('toggleFiltersBtn');
  const filtersContainer = document.getElementById('filtersContainer');
  const gridContainer = document.querySelector('.containerGrid');
  const animationDelay = 400; // ms, slightly less than CSS transition duration (500ms)

  toggleBtn?.addEventListener('click', () => {
    const isCurrentlyCollapsed = filtersContainer.classList.contains('collapsed');

    // Toggle button active state immediately
    toggleBtn.classList.toggle('active');

    if (isCurrentlyCollapsed) {
      // === Expand Sequence ===
      // 1. Start grid expanding (remove class)
      gridContainer?.classList.remove('filters-collapsed');
      // 2. Wait, then start filter expansion (remove class)
      setTimeout(() => {
        filtersContainer.classList.remove('collapsed');
      }, animationDelay);
    } else {
      // === Collapse Sequence ===
      // 1. Start filter collapsing (add class)
      filtersContainer.classList.add('collapsed');
      // 2. Wait, then start grid collapsing (add class)
      setTimeout(() => {
        gridContainer?.classList.add('filters-collapsed');
      }, animationDelay);
    }
  });
</script>

<!-- noUiSlider JS and initialization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
<script>
  const slider = document.getElementById('price-slider');
  if (slider) {
    const minDisp = document.getElementById('slider-price-min');
    const maxDisp = document.getElementById('slider-price-max');
    noUiSlider.create(slider, {
      start: [0, 2000],
      connect: true,
      range: { min: 0, max: 2000 },
      step: 10,
      format: {
        to: v => Math.round(v),
        from: v => Number(v)
      }
    });
    slider.noUiSlider.on('update', (values) => {
      minDisp.textContent = values[0];
      maxDisp.textContent = values[1];
    });
  }

  // Star‐rating click handler
  document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', () => {
      const val = star.getAttribute('data-value');
      document.querySelectorAll('.star').forEach(s => {
        s.classList.toggle('filled', s.getAttribute('data-value') <= val);
      });
    });
  });
</script>
{% endblock %}