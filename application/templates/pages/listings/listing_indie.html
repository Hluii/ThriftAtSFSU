{% extends "base.html" %}
{% block title %}{{ product.title | default('Listing Details') }} â€“ SFSU Thrift Market{% endblock %}

{% block content %}
{% if product %}
<section class="listingInfo">
  <div class="product-container">
    <div class="product-image image-carousel-container">
      {% if image_ids %}
        <div class="carousel-images">
          {% for image_id in image_ids %}
            <div class="carousel-slide {{ 'active' if loop.first }}">
              <img src="{{ url_for('serve_image', image_id=image_id) }}" alt="{{ product.title }} - Image {{ loop.index }}">
            </div>
          {% endfor %}
        </div>

        {% if image_ids | length > 1 %}
          {# <button class="carousel-arrow prev" aria-label="Previous image">&#10094;</button> #}
          {# <button class="carousel-arrow next" aria-label="Next image">&#10095;</button> #}
          <div class="carousel-dots">
            {% for image_id in image_ids %}
              <span class="dot {{ 'active' if loop.first }}" data-slide-index="{{ loop.index0 }}"></span>
            {% endfor %}
          </div>
        {% endif %}

      {% else %}
        {# Display placeholder if no images #}
        <div class="carousel-slide active">
          <img src="{{ url_for('static', filename='templatephotos/placeholder_img.png') }}" alt="Placeholder Image">
        </div>
      {% endif %}
    </div>
    <div class="product-details">
      <h1 class="product-title-large">{{ product.title }}</h1>
      <h2 class="product-price">${{ "%.2f"|format(product.price) }}</h2>
      {# Product Condition is not in DB schema, using placeholder or passed value #}
      <p class="product-condition">Condition: {{ product.condition | default('Not specified') }}</p>
      
      <h3 class="product-description-title">Description
        {% if is_owner %}
          <button id="edit-description-btn" class="edit-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
          </button>
        {% endif %}
      </h3>
      
      <!-- View Mode -->
      <p id="description-text" class="product-description">{{ product.description | default('No description provided.') }}</p>
      
      <!-- Edit Mode (initially hidden) -->
      {% if is_owner %}
      <div id="description-edit-container" style="display: none;">
        <textarea id="description-textarea" maxlength="1000" rows="5" style="width:100%">{{ product.description or '' }}</textarea>
        <div class="char-count"><span id="description-char-count">0</span>/1000</div>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
          <button id="save-description-btn" class="btn btn-sm">Save</button>
          <button id="cancel-description-btn" class="btn-outline btn-sm">Cancel</button>
        </div>
      </div>
      {% endif %}
      
      <p class="product-category">Category: {{ product.category_name | default('Unknown') }}</p>
      <p class="product-status">Status: {{ product.status | capitalize }}</p>
      <p class="posted-date">Posted on: {{ product.created_at.strftime('%Y-%m-%d') if product.created_at else 'N/A' }}</p>
      
      <div class="seller-profile">
        <div class="profile-pic">
          {# Link to the dynamic profile page #}
          <a href="{{ url_for('view_profile', profile_user_id=product.seller_id) }}">
            <img src="{{ url_for('serve_user_picture', user_id=product.seller_id) }}" alt="{{ product.seller_username }}'s Profile Picture" class="rounded-circle me-2" width="40" height="40">
          </a>
          <span>Sold by:
            <a href="{{ url_for('view_profile', profile_user_id=product.seller_id) }}" class="text-decoration-none">
              {{ product.seller_username | default('Unknown Seller') }}
            </a>
          </span>
        </div>
        <div class="profile-actions">
          {# Link to seller profile page (if it exists) #}
          {# <button class="btn btn-purple">View Profile</button> #} 
          {# Link to contact seller (if messaging exists) #}
          {# <button class="btn btn-purple">Contact Seller</button> #}
          {# Link to ratings (if ratings exist) #}
          {# <button class="btn btn-purple">Ratings</button> #}
          {# Add to Wishlist button? #}
          {# <button class="btn btn-outline-secondary">Add to Wishlist</button> #}
        </div>
      </div>
    </div>

    {% if is_owner %}
    <div class="owner-actions">
      <form action="{{ url_for('delete_product', product_id=product.product_id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this listing? This action cannot be undone.')">
        <button type="submit" class="btn-delete">Delete Listing</button>
      </form>
    </div>
    {% endif %}
  </div>
</section>
{% else %}
  <div class="alert alert-warning" role="alert">
    Product details could not be loaded or the product does not exist.
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
{# Add carousel JS only if there is more than one image #}
{% if image_ids and image_ids | length > 1 %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const carousel = document.querySelector('.image-carousel-container');
    if (!carousel) return; // Exit if carousel container not found

    const slides = carousel.querySelectorAll('.carousel-slide');
    const dotsContainer = carousel.querySelector('.carousel-dots');
    const dots = dotsContainer ? dotsContainer.querySelectorAll('.dot') : [];
    const prevButton = carousel.querySelector('.carousel-arrow.prev');
    const nextButton = carousel.querySelector('.carousel-arrow.next');
    let currentSlide = 0;
    const totalSlides = slides.length;

    function showSlide(index) {
      // Ensure index is within bounds
      if (index >= totalSlides) {
        currentSlide = 0;
      } else if (index < 0) {
        currentSlide = totalSlides - 1;
      } else {
        currentSlide = index;
      }

      // Hide all slides
      slides.forEach(slide => {
        slide.classList.remove('active');
      });

      // Show the target slide
      slides[currentSlide].classList.add('active');

      // Update dots
      if (dots.length > 0) {
        dots.forEach(dot => {
          dot.classList.remove('active');
        });
        dots[currentSlide].classList.add('active');
      }
    }

    // Event Listeners for Arrows (Removed as buttons are commented out)
    /*
    if (prevButton) {
        prevButton.addEventListener('click', function() {
            showSlide(currentSlide - 1);
        });
    }
    if (nextButton) {
        nextButton.addEventListener('click', function() {
            showSlide(currentSlide + 1);
        });
    }
    */

    // Event Listeners for Dots
    if (dots.length > 0) {
        dots.forEach(dot => {
            dot.addEventListener('click', function() {
                const slideIndex = parseInt(this.getAttribute('data-slide-index'));
                showSlide(slideIndex);
            });
        });
    }

    // Initialize the first slide
    showSlide(currentSlide);
  });
</script>
{% endif %}

{% if is_owner %}
<script>
  // Description editing functionality
  const editDescriptionBtn = document.getElementById('edit-description-btn');
  const descriptionText = document.getElementById('description-text');
  const descriptionEditContainer = document.getElementById('description-edit-container');
  const descriptionTextarea = document.getElementById('description-textarea');
  const descriptionCharCount = document.getElementById('description-char-count');
  const saveDescriptionBtn = document.getElementById('save-description-btn');
  const cancelDescriptionBtn = document.getElementById('cancel-description-btn');

  if (editDescriptionBtn) {
    // Update char count initially
    descriptionCharCount.textContent = descriptionTextarea.value.length;
    
    // Toggle edit mode
    editDescriptionBtn.addEventListener('click', function() {
      descriptionText.style.display = 'none';
      descriptionEditContainer.style.display = 'block';
      descriptionTextarea.focus();
    });
    
    // Character count
    descriptionTextarea.addEventListener('input', function() {
      descriptionCharCount.textContent = descriptionTextarea.value.length;
    });
    
    // Cancel editing
    cancelDescriptionBtn.addEventListener('click', function() {
      descriptionText.style.display = 'block';
      descriptionEditContainer.style.display = 'none';
      // Reset textarea to original value
      descriptionTextarea.value = descriptionText.textContent === 'No description provided.' ? '' : descriptionText.textContent;
      descriptionCharCount.textContent = descriptionTextarea.value.length;
    });
    
    // Save description changes
    saveDescriptionBtn.addEventListener('click', function() {
      const newDescription = descriptionTextarea.value.trim();
      
      // Create form data for the request
      const formData = new FormData();
      formData.append('description', newDescription);
      formData.append('product_id', '{{ product.product_id }}');
      
      // Show saving state
      saveDescriptionBtn.textContent = 'Saving...';
      saveDescriptionBtn.disabled = true;
      
      // Send AJAX request
      fetch('{{ url_for("update_product_description") }}', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Update displayed description
          descriptionText.textContent = newDescription || 'No description provided.';
          
          // Return to view mode
          descriptionText.style.display = 'block';
          descriptionEditContainer.style.display = 'none';
          
          // Show a temporary success message
          const successMsg = document.createElement('div');
          successMsg.textContent = 'Description updated!';
          successMsg.style.color = 'green';
          successMsg.style.fontSize = '0.9rem';
          successMsg.style.marginTop = '0.5rem';
          descriptionText.parentNode.insertBefore(successMsg, descriptionText.nextSibling);
          
          // Remove message after 3 seconds
          setTimeout(() => {
            successMsg.remove();
          }, 3000);
        } else {
          alert('Error: ' + (data.message || 'Failed to update description'));
        }
      })
      .catch(error => {
        console.error('Error updating description:', error);
        alert('An error occurred while updating your product description');
      })
      .finally(() => {
        // Reset button
        saveDescriptionBtn.textContent = 'Save';
        saveDescriptionBtn.disabled = false;
      });
    });
  }
</script>
{% endif %}
{% endblock %}
